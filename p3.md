# План: Добавление transport/headers/payload в resources/list

## Цель

Сделать `customResources` аналогично `tools` и `customPrompts`:
- Может быть массивом `IResourceData[]` или async функцией `(args) => Promise<IResourceData[]>`
- Функция получает `{ transport, headers, payload }`

## Изменения по файлам

### 1. `src/core/_types_/types.ts`

- Добавить тип `IGetResourcesArgs` (аналог `IGetToolsArgs` и `IGetPromptsArgs`):
  ```typescript
  export interface IGetResourcesArgs {
    transport: TransportType;
    headers?: Record<string, string>;
    payload?: { user: string; [key: string]: any };
  }
  ```

- Изменить тип `customResources` в `McpServerData`:
  ```typescript
  customResources?: IResourceData[] | ((args: IGetResourcesArgs) => Promise<IResourceData[]>) | null;
  ```

### 2. `src/core/index.ts`

- Добавить экспорт `IGetResourcesArgs`

### 3. `src/core/mcp/resources.ts`

- Сделать `createResources` асинхронной функцией с параметром `args: IGetResourcesArgs`
- В `createResources` проверять тип `customResources`:
  - Если функция — вызвать с args
  - Если массив — использовать напрямую
- Убрать кеширование `_resources` (результат зависит от args)
- `getResourcesList` станет async и будет принимать `args: IGetResourcesArgs`
- `getResource` тоже должен принимать args для получения актуального списка ресурсов

### 4. `src/core/web/server-http.ts`

- `resources/list`: вызывать `await getResourcesList({ transport: 'http', headers, payload })`
- `resources/read`: вызывать `await getResource(uri, { transport: 'http', headers, payload })`
- SSE: переопределить `ListResourcesRequestSchema` в `createSseServer` (как сделано для tools и prompts)

### 5. `src/core/mcp/create-mcp-server.ts`

- `ListResourcesRequestSchema`: вызывать `await getResourcesList({ transport: 'stdio' })`
- `ReadResourceRequestSchema`: вызывать `await getResource(uri, { transport: 'stdio' })`

### 6. `src/core/web/home-api.ts`

- Вызывать `await getResourcesList({ transport: 'http' })`

### 7. `src/core/auth/middleware.ts`

- `isPublicResource`: вызывать `await getResourcesList(...)` — функция станет async
- Это повлияет на `isPublicMcpRequest` — тоже станет async
- Передавать минимальные args: `{ transport: 'http' }` (headers/payload недоступны в этом контексте, проверка публичности не зависит от них)

### 8. `cli-template/FA-MCP-SDK-DOC/02-2-prompts-and-resources.md`

- Документировать возможность использования функции для `customResources`

### 9. `src/template/custom-resources.ts` (опционально)

- Добавить пример использования функции вместо массива

## Примечания

- В `middleware.ts` функции `isPublicResource` и `isPublicMcpRequest` станут async
- Это не критично, так как middleware уже async
- Для проверки публичности ресурса передаем `{ transport: 'http' }` без headers/payload, так как проверка `requireAuth` не должна зависеть от пользователя
